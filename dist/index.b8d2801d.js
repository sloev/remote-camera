/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let e,t,i,n,s,r,a,o,d,c;function h(e){let t=new Uint8Array(e);for(let i=0;i<e;i++)t[i]=256*Math.random()|0;return t}function l(){if("undefined"==typeof globalThis)return null;let e={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}function _(e,t){return Object.defineProperty(e,"code",{value:t,enumerable:!0,configurable:!0}),e}function g(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}class u{constructor(e={}){if(this._map=new Map,this._id=h(4).toString("hex").slice(0,7),this._doDebug=e.debug,this._debug("new peer %o",e),this.channelName=e.initiator?e.channelName||h(20).toString("hex"):null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||u.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},u.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.streams=e.streams||(e.stream?[e.stream]:[]),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=e.wrtc&&"object"==typeof e.wrtc?e.wrtc:l(),!this._wrtc){if("undefined"==typeof window)throw _(Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT");throw _(Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT")}this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(e){this.destroy(_(e,"ERR_PC_CONSTRUCTOR"));return}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch(e=>{this.destroy(_(e,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this.streams&&this.streams.forEach(e=>{this.addStream(e)}),this._pc.ontrack=e=>{this._onTrack(e)},this._debug("initial negotiation"),this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(!this.destroying){if(this.destroyed)throw _(Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(e=>{this._addIceCandidate(e)}),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())}).catch(e=>{this.destroy(_(e,"ERR_SET_REMOTE_DESCRIPTION"))}),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(_(Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){let t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch(e=>{!t.address||t.address.endsWith(".local")?console.warn("Ignoring unsupported ICE candidate."):this.destroy(_(e,"ERR_ADD_ICE_CANDIDATE"))})}send(e){if(!this.destroying){if(this.destroyed)throw _(Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}addTransceiver(e,t){if(!this.destroying){if(this.destroyed)throw _(Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(e){this.destroy(_(e,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:t}})}}addStream(e){if(!this.destroying){if(this.destroyed)throw _(Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),e.getTracks().forEach(t=>{this.addTrack(t,e)})}}addTrack(e,t){if(this.destroying)return;if(this.destroyed)throw _(Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");let i=this._senderMap.get(e)||new Map,n=i.get(t);if(n){if(n.removed)throw _(Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED");throw _(Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}n=this._pc.addTrack(e,t),i.set(t,n),this._senderMap.set(e,i),this._needsNegotiation()}replaceTrack(e,t,i){if(this.destroying)return;if(this.destroyed)throw _(Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");let n=this._senderMap.get(e),s=n?n.get(i):null;if(!s)throw _(Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,n),null!=s.replaceTrack?s.replaceTrack(t):this.destroy(_(Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){if(this.destroying)return;if(this.destroyed)throw _(Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");let i=this._senderMap.get(e),n=i?i.get(t):null;if(!n)throw _(Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{n.removed=!0,this._pc.removeTrack(n)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?this._sendersAwaitingStable.push(n):this.destroy(_(e,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){if(!this.destroying){if(this.destroyed)throw _(Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),e.getTracks().forEach(t=>{this.removeTrack(t,e)})}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this.destroying){if(this.destroyed)throw _(Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(e){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",e&&(e.message||e)),queueMicrotask(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",e&&(e.message||e)),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")}))}_setupData(e){if(!e.channel)return this.destroy(_(Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=65536),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{this.destroy(_(e,"ERR_DATA_CHANNEL"))};let t=!1;this._closingInterval=setInterval(()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1},5e3)}_startIceCompleteTimeout(){!this.destroyed&&(this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout)))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=g(e.sdp)),e.sdp=this.sdpTransform(e.sdp);let t=()=>{if(this.destroyed)return;let t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then(()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))}).catch(e=>{this.destroy(_(e,"ERR_SET_LOCAL_DESCRIPTION"))})}).catch(e=>{this.destroy(_(e,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(e=>{e.mid||!e.sender.track||e.requested||(e.requested=!0,this.addTransceiver(e.sender.track.kind))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=g(e.sdp)),e.sdp=this.sdpTransform(e.sdp);let t=()=>{if(this.destroyed)return;let t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp}),this.initiator||this._requestMissingTransceivers()};this._pc.setLocalDescription(e).then(()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))}).catch(e=>{this.destroy(_(e,"ERR_SET_LOCAL_DESCRIPTION"))})}).catch(e=>{this.destroy(_(e,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||"failed"!==this._pc.connectionState||this.destroy(_(Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;let e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),("connected"===e||"completed"===e)&&(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(_(Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.destroy(_(Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){let t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach(t=>{Object.assign(e,t)}),e);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then(i=>{let n=[];i.forEach(e=>{n.push(t(e))}),e(null,n)},t=>e(t)):this._pc.getStats.length>0?this._pc.getStats(i=>{if(this.destroyed)return;let n=[];i.result().forEach(e=>{let i={};e.names().forEach(t=>{i[t]=e.stat(t)}),i.id=e.id,i.type=e.type,i.timestamp=e.timestamp,n.push(t(i))}),e(null,n)},t=>e(t)):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;let e=()=>{this.destroyed||this.getStats((t,i)=>{if(this.destroyed)return;t&&(i=[]);let n={},s={},r={},a=!1;i.forEach(e=>{("remotecandidate"===e.type||"remote-candidate"===e.type)&&(n[e.id]=e),("localcandidate"===e.type||"local-candidate"===e.type)&&(s[e.id]=e),("candidatepair"===e.type||"candidate-pair"===e.type)&&(r[e.id]=e)});let o=e=>{a=!0;let t=s[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let i=n[e.remoteCandidateId];i&&(i.ip||i.address)?(this.remoteAddress=i.ip||i.address,this.remotePort=Number(i.port)):i&&i.ipAddress?(this.remoteAddress=i.ipAddress,this.remotePort=Number(i.portNumber)):"string"==typeof e.googRemoteAddress&&(i=e.googRemoteAddress.split(":"),this.remoteAddress=i[0],this.remotePort=Number(i[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(i.forEach(e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(r[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)}),a||Object.keys(r).length&&!Object.keys(s).length)this._connecting=!1,this._connected=!0;else{setTimeout(e,100);return}if(this._chunk){try{this.send(this._chunk)}catch(e){return this.destroy(_(e,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');let e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};e()}_onInterval(){this._cb&&this._channel&&!(this._channel.bufferedAmount>65536)&&this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){!this.destroyed&&(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=new Uint8Array(t)),this.emit("data",t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);let e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(e){this.destroyed||e.streams.forEach(t=>{this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),this._remoteStreams.some(e=>e.id===t.id)||(this._remoteStreams.push(t),queueMicrotask(()=>{this._debug("on stream"),this.emit("stream",t)}))})}_debug(...e){this._doDebug&&(e[0]="["+this._id+"] "+e[0],console.log(...e))}on(e,t){let i=this._map;i.has(e)||i.set(e,new Set),i.get(e).add(t)}off(e,t){let i=this._map,n=i.get(e);n&&(n.delete(t),0===n.size&&i.delete(e))}once(e,t){let i=(...n)=>{this.off(e,i),t(...n)};this.on(e,i)}emit(e,...t){let i=this._map;if(i.has(e))for(let n of i.get(e))try{n(...t)}catch(e){console.error(e)}}}u.WEBRTC_SUPPORT=!!l(),u.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},u.channelConfig={};const p="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",m=(e,t,i)=>{let n=new u({initiator:e,trickle:t,config:i}),s=e=>n.__earlyDataBuffer.push(e);return n.on(A.data,s),n.__earlyDataBuffer=[],n.__drainEarlyData=e=>{n.off(A.data,s),n.__earlyDataBuffer.forEach(e),delete n.__earlyDataBuffer,delete n.__drainEarlyData},n},f=e=>Array(e).fill().map(()=>p[Math.floor(Math.random()*p.length)]).join(""),y="Trystero",b=f(20),{keys:C,values:E,entries:w,fromEntries:R}=Object,T=()=>{},v=e=>Error(`${y}: ${e}`),S=e=>new TextEncoder().encode(e),k=e=>new TextDecoder().decode(e),A=R(["close","connect","data","error","signal","stream","track"].map(e=>[e,e])),N=(e,t,i)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||i),I=e=>new Promise(t=>setTimeout(t,e)),D=Object.getPrototypeOf(Uint8Array),O="bufferedamountlow";var P=(e,t)=>{let i={},n={},s={},r={},a={},o={},d=(e,t)=>(e?Array.isArray(e)?e:[e]:C(i)).flatMap(e=>{let n=i[e];return n?t(e,n):(console.warn(`${y}: no peer with id ${e} found`),[])}),c=e=>{i[e]&&(delete i[e],delete s[e],delete r[e],L(e))},h=e=>{if(n[e])return[n[e].send,n[e].setOnComplete,n[e].setOnProgress];if(!e)throw v("action type argument is required");let t=S(e);if(t.byteLength>12)throw v(`action type string "${e}" (${t.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);let s=new Uint8Array(12);s.set(t);let r=0;return n[e]={onComplete:T,onProgress:T,setOnComplete:t=>n[e]={...n[e],onComplete:t},setOnProgress:t=>n[e]={...n[e],onProgress:t},send:async(e,t,n,a)=>{if(n&&"object"!=typeof n)throw v("action meta argument must be an object");if(void 0===e)throw v("action data cannot be undefined");let o="string"!=typeof e,c=e instanceof Blob,h=c||e instanceof ArrayBuffer||e instanceof D;if(n&&!h)throw v("action meta argument can only be used with binary data");let l=h?new Uint8Array(c?await e.arrayBuffer():e):S(o?JSON.stringify(e):e),_=n?S(JSON.stringify(n)):null,g=Math.ceil(l.byteLength/16369)+(n?1:0)||1,u=Array(g).fill().map((e,t)=>{let i=t===g-1,a=n&&0===t,d=new Uint8Array(15+(a?_.byteLength:i?l.byteLength-16369*(g-(n?2:1)):16369));return d.set(s),d.set([r],12),d.set([i|a<<1|h<<2|o<<3],13),d.set([Math.round((t+1)/g*255)],14),d.set(n?a?_:l.subarray((t-1)*16369,16369*t):l.subarray(16369*t,(t+1)*16369),15),d});return r=r+1&255,Promise.all(d(t,async(e,t)=>{let s=t._channel,r=0;for(;r<g;){let o=u[r];if(s.bufferedAmount>s.bufferedAmountLowThreshold&&await new Promise(e=>{let t=()=>{s.removeEventListener(O,t),e()};s.addEventListener(O,t)}),!i[e])break;t.send(o),r++,a&&a(o[14]/255,e,n)}}))}},[n[e].send,n[e].setOnComplete,n[e].setOnProgress]},l=(e,t)=>{let i=new Uint8Array(t),r=k(i.subarray(0,12)).replaceAll("\0",""),[a]=i.subarray(12,13),[o]=i.subarray(13,14),[d]=i.subarray(14,15),c=i.subarray(15);if(!n[r])throw v(`received message with unregistered type (${r})`);s[e]||(s[e]={}),s[e][r]||(s[e][r]={});let h=s[e][r][a];if(h||(h=s[e][r][a]={chunks:[]}),2&o?h.meta=JSON.parse(k(c)):h.chunks.push(c),n[r].onProgress(d/255,e,h.meta),!(1&o))return;let l=new Uint8Array(h.chunks.reduce((e,t)=>e+t.byteLength,0));if(h.chunks.reduce((e,t)=>(l.set(t,e),e+t.byteLength),0),4&o)n[r].onComplete(l,e,h.meta);else{let t=k(l);n[r].onComplete(8&o?JSON.parse(t):t,e)}delete s[e][r][a]},[_,g]=h("__91n6__"),[u,p]=h("__90n6__"),[m,f]=h("__516n4L__"),[b,E]=h("__57r34m__"),[N,I]=h("__7r4ck__"),P=T,L=T,U=T,M=T;return e((e,t)=>{if(i[t])return;let n=l.bind(null,t);i[t]=e,e.on(A.signal,e=>m(e,t)),e.on(A.close,()=>c(t)),e.on(A.data,n),e.on(A.stream,e=>{U(e,t,a[t]),delete a[t]}),e.on(A.track,(e,i)=>{M(e,i,t,o[t]),delete o[t]}),e.on(A.error,e=>{"ERR_DATA_CHANNEL"!==e.code&&console.error(e)}),P(t),e.__drainEarlyData(n)}),g((e,t)=>u("",t)),p((e,t)=>{r[t]&&(r[t](),delete r[t])}),f((e,t)=>{i[t]&&i[t].signal(e)}),E((e,t)=>a[t]=e),I((e,t)=>o[t]=e),{makeAction:h,ping:async e=>{if(!e)throw v("ping() must be called with target peer ID");let t=Date.now();return _("",e),await new Promise(t=>r[e]=t),Date.now()-t},leave:()=>{w(i).forEach(([e,t])=>{t.destroy(),delete i[e]}),t()},getPeers:()=>R(w(i).map(([e,t])=>[e,t._pc])),addStream:(e,t,i)=>d(t,async(t,n)=>{i&&await b(i,t),n.addStream(e)}),removeStream:(e,t)=>d(t,(t,i)=>i.removeStream(e)),addTrack:(e,t,i,n)=>d(i,async(i,s)=>{n&&await N(n,i),s.addTrack(e,t)}),removeTrack:(e,t,i)=>d(i,(i,n)=>n.removeTrack(e,t)),replaceTrack:(e,t,i,n,s)=>d(n,async(n,r)=>{s&&await N(s,n),r.replaceTrack(e,t,i)}),onPeerJoin:e=>P=e,onPeerLeave:e=>L=e,onPeerStream:e=>U=e,onPeerTrack:e=>M=e}};const L="AES-CBC",U=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),M=e=>{let t=atob(e);return new Uint8Array(t.length).map((e,i)=>t.charCodeAt(i)).buffer},q=async(e,t)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},S(`${e}:${t}`)),{name:L},!1,["encrypt","decrypt"]),B=async(e,t)=>{let i=crypto.getRandomValues(new Uint8Array(16));return JSON.stringify({c:U(await crypto.subtle.encrypt({name:L,iv:i},await e,S(t))),iv:[...i]})},j=async(e,t)=>{let{c:i,iv:n}=JSON.parse(t);return k(await crypto.subtle.decrypt({name:L,iv:new Uint8Array(n)},await e,M(i)))},z={},J={},$={},x={},H={},W="announce",Y=["wss://tracker.webtorrent.dev","wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.btorrent.xyz"],F=(c=(e,t)=>{let i;if(e.trackerUrls||e.trackerRedundancy)throw v("trackerUrls/trackerRedundancy have been replaced by relayUrls/relayRedundancy");let n={},s=e.password&&q(e.password,t),r=N(e,Y,3),a=crypto.subtle.digest("SHA-1",S(`${y}:${e.appId}:${t}`)).then(e=>Array.from(new Uint8Array(e)).map(e=>e.toString(36)).join("").slice(0,20)),o=t=>R(Array(t).fill().map(()=>{let t=m(!0,!1,e.rtcConfig);return[f(20),{peer:t,offerP:new Promise(e=>t.once(A.signal,e))}]})),d=async(t,r)=>{let o;let d=await a;try{o=JSON.parse(r.data)}catch(e){console.error(`${y}: received malformed SDP JSON`);return}if(o.info_hash!==d||o.peer_id&&o.peer_id===b)return;let c=o["failure reason"];if(c){console.warn(`${y}: torrent tracker failure from ${t.url} - ${c}`);return}if(o.interval&&o.interval>p&&o.interval<=120&&(clearInterval(C),C=setInterval(l,1e3*(p=o.interval))),o.offer&&o.offer_id){if(n[o.peer_id]||D[o.offer_id])return;D[o.offer_id]=!0;let i=m(!1,!1,e.rtcConfig);i.once(A.signal,async e=>t.send(JSON.stringify({answer:s?{...e,sdp:await B(s,e.sdp)}:e,action:W,info_hash:d,peer_id:b,to_peer_id:o.peer_id,offer_id:o.offer_id}))),i.on(A.connect,()=>g(i,o.peer_id)),i.on(A.close,()=>u(i,o.peer_id,o.offer_id)),i.signal(s?{...o.offer,sdp:await j(s,o.offer.sdp)}:o.offer);return}if(o.answer){if(n[o.peer_id]||D[o.offer_id])return;let e=i[o.offer_id];if(e){let{peer:t}=e;if(t.destroyed)return;D[o.offer_id]=!0,t.on(A.connect,()=>g(t,o.peer_id,o.offer_id)),t.on(A.close,()=>u(t,o.peer_id,o.offer_id)),t.signal(s?{...o.answer,sdp:await j(s,o.answer.sdp)}:o.answer)}}},c=async(e,t)=>e.send(JSON.stringify({action:W,info_hash:t,numwant:10,peer_id:b,offers:await Promise.all(w(i).map(async([e,{offerP:t}])=>{let i=await t;return{offer_id:e,offer:s?{...i,sdp:await B(s,i.sdp)}:i}}))})),h=(e,t,i)=>(i||!J[e]?(H[e]={...H[e],[t]:d},J[e]=new Promise(i=>{let n=new WebSocket(e);$[e]=n,n.addEventListener("open",()=>{x[e]=4e3,i(n)}),n.addEventListener("message",t=>E(H[e]).forEach(e=>e(n,t))),n.addEventListener("close",async()=>{x[e]=x[e]??4e3,await I(x[e]),x[e]*=2,h(e,t,!0)})})):H[e][t]=d,J[e]),l=async()=>{let e=await a;i&&_(),i=o(10),r.forEach(async t=>{let i=await h(t,e);i.readyState===WebSocket.OPEN?c(i,e):i.readyState!==WebSocket.CONNECTING&&c(await h(t,e,!0),e)})},_=()=>{w(i).forEach(([e,{peer:t}])=>{D[e]||n[e]||t.destroy()}),D={}},g=(e,t,i)=>{k(e,t),n[t]=!0,i&&(n[i]=!0)},u=(e,t,s)=>{delete n[t],e.destroy(),s in i&&(delete i[s],i={...i,...o(1)})},p=33,C=setInterval(l,33e3),k=T,D={};return l(),P(e=>k=e,async()=>{let e=await a;r.forEach(t=>delete H[t][e]),delete z[t],clearInterval(C),_()})},(e,t)=>{if(z[t])return z[t];if(!e)throw v("requires a config map as the first argument");if(!e.appId&&!e.firebaseApp)throw v("config map is missing appId field");if(!t)throw v("namespace argument required");return z[t]=c(e,t)}),V={roomId:null,isCamera:!1};async function K(){e&&e.leave(),e=null;var c,h=window.location.hash.substring(1);if(console.log("hash on page load is",h),void 0!==h&&""!==h){if(console.log("whoa"),console.log("got data:",c=function(e){console.log("s",e);try{return JSON.parse(decodeURIComponent(e))}catch(e){console.error("derp!",e);return}}(h)),void 0===c)return;void 0!==c.roomId&&(V.roomId=c.roomId,Z.value=V.roomId,e=F({appId:"lolcat"},roomId),[t,i]=e.makeAction("pic"),[r,a]=e.makeAction("zoom"),[o,d]=e.makeAction("takepic"),[n,s]=e.makeAction("settings"),console.log(e)),void 0!==c.isCamera&&(V.isCamera=c.isCamera,ee.checked=V.isCamera),V.isCamera?navigator.mediaDevices.getUserMedia({audio:!1,video:!0,facingMode:{exact:"environment"}}).then(i=>{let[s]=i.getVideoTracks(),r=s.getCapabilities(),o=s.getSettings();"zoom"in o&&(n({min:r.zoom.min,max:r.zoom.max,step:r.zoom.step,value:o.zoom}),a((e,t)=>{console.log("got zoom level",e),s.applyConstraints({advanced:[{zoom:e.zoomLevel}]})})),d(()=>{(function(e){if("ImageCapture"in window)return new ImageCapture(e.getVideoTracks()[0]).takePhoto();{let t=document.createElement("video"),i=document.createElement("canvas"),n=i.getContext("2d");return t.srcObject=e,new Promise((e,s)=>{t.addEventListener("loadeddata",async()=>{let{videoWidth:r,videoHeight:a}=t;i.width=r,i.height=a;try{await t.play(),n.drawImage(t,0,0,r,a),i.toBlob(e,"image/jpg")}catch(e){s(e)}})})}})(i).then(e=>{t(e)})}),e.addStream(i),e.onPeerJoin(t=>e.addStream(i,t))}):(s((e,t)=>{X.min=e.min,X.max=e.max,X.step=e.step,X.value=e.value}),i((e,t)=>{let i=window.URL.createObjectURL(new Blob([e])),n=document.createElement("a");n.href=i,n.download="img.jpg",n.style.display="none",document.body.appendChild(n),n.click(),n.remove(),window.URL.revokeObjectURL(i)}),e.onPeerStream((e,t)=>{console.log("got video from peer:",t),et.srcObject=e,et.addEventListener("loadedmetadata",()=>{et.play()})}))}}var G=document.getElementById("form"),X=document.getElementById("zoom"),Q=document.getElementById("shoot");X.onchange=e=>{var t=e.target.value;console.log("change zoom",t),r({zoomLevel:t})},Q.onclick=()=>{console.log("take picture"),o({})};var Z=document.getElementById("roomId"),ee=document.getElementById("isCamera");const et=document.getElementById("camera");G.onsubmit=function(e){e.preventDefault();var t=Object.fromEntries(new FormData(G));return V.roomId=t.roomId,V.isCamera=!!t.isCamera,console.log(V,t),window.location.hash=encodeURIComponent(JSON.stringify(V)),location.reload(),!1},K();
//# sourceMappingURL=index.b8d2801d.js.map
